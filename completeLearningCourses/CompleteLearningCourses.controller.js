sap.ui.define(["sap/sf/workflow/returntoworkplace_employee/controller/BaseController","sap/ui/model/json/JSONModel"],function(e,t){"use strict";const o="|";var r=-1;return e.extend("workzone2.workzonehr.sap.sf.workflow.returntoworkplace_employee.completeLearningCourses.completeLearningCourses",{onInit:function(){console.info("step3");let e=new t;this.getView().setModel(e);e.setProperty("/mandatoryCourses",[]);e.setProperty("/optionalCourses",[]);let o=this.getSelectedCourses();console.log("###0 selectedCourses:",o);clearInterval(r);r=setInterval(this.initCourses.bind(this),1e4,o)},initCourses:function(e){let t=this.getView().getModel();return Promise.all([this.fetchCourseDetails(e),this.fetchCourseRatings(e)]).then(e=>{let o=[e[0].mandatoryCourses,e[0].optionalCourses];let n=e[1];console.log("###3-Found mandatory: "+o[0].length+"||Found optional: "+o[1].length);o.forEach(e=>{e.forEach(e=>{e.dueDate=this.handleDueDate(e);e.itemThumbnailURI=this.handleDefaultImage(e);e.ratings=this.handleCourseRating(e,n)})});console.log("###3-Finished Assembly: ",o);if(!o[0].length&&!o[1].length){clearInterval(r)}if(!o[0].length&&this.getGlobalModel().getProperty("/mdfObjConfigCorrect")!==false){this.getView().step.setValidated(true);this.getGlobalModel().setProperty("/MandatoryCourseComplete",true)}t.setProperty("/mandatoryCourses",o[0]);t.setProperty("/optionalCourses",o[1])}).catch(e=>{console.error("###0-Error in initCourses: ",e)})},beforeStepComplete:function(){clearInterval(r)},fetchCourseDetails:function(e){if(!e.length){return{mandatoryCourses:[],optionalCourses:[]}}return this.getOwnerComponent().card.request({url:"{{destinations.sfDestination}}/rest/experience/workzone/v1/EligibleEmployeeCourses",method:"POST",headers:{"content-type":"application/json"},parameters:e,withCredentials:true}).then(e=>{console.log("###2-PickedCourses: ",e);return e}).catch(e=>{console.error("###2-Error in fetchCourseDetails: ",e)})},fetchCourseRatings:function(e){if(!e.length){return[]}return this.getOwnerComponent().card.request({url:"{{destinations.sfDestination}}/rest/experience/workzone/v1/EligibleEmployeeCourses/Ratings",method:"POST",headers:{"content-type":"application/json"},parameters:e,withCredentials:true}).then(e=>{console.log("###1-Ratings: ",e);return e}).catch(e=>{console.error("###1-Error in fetchCourseRating: ",e);return[]})},onPressActionButton:function(e){const t=e.getSource().getBindingContext().getPath();const o=this.getView().getModel().getProperty(t);console.log("itemDetailsDeeplink",o);const r=o.itemDetailsDeeplink;console.log(r);window.open(r,"_blank")},handleDueDate:function(e){const t=e.daysRemaining;const o=e.requiredDate;const r=this.getI18nResource();const n=r.getText("COMPLETE_LEARNING_COURSE_STEP_OVERDUE");const s=r.getText("COMPLETE_LEARNING_COURSE_STEP_DUE_ANYTIME");let a="";let i="None";if(t===null){a=s}else if(t<=0){a=n;i="Error"}else{let e=sap.ui.core.format.DateFormat.getInstance();a=r.getText("COMPLETE_LEARNING_COURSE_STEP_DUE_DATE",[e.format(new Date(o))])}return{requiredDateText:a,requiredDateStatus:i}},handleDefaultImage:function(e){let t=e.itemThumbnailURI;const o=e.itemClassification;const r="sap/sf/workflow/returntoworkplace_employee/completeLearningCourses/img/";if(t===null){switch(o){case"CONTINUOUS ONLINE ACCESS":t=sap.ui.require.toUrl(r+"Online/280444_GettyImages-525975242_low.jpg");break;case"EXTERNAL-COURSE":t=sap.ui.require.toUrl(r+"External/280863_GettyImages-602323633_full_low.jpg");break;case"TIME-BASED":t=sap.ui.require.toUrl(r+"Instructor-led/280663_GettyImages-168831200_super_low.jpg");break;case"BLENDED":t=sap.ui.require.toUrl(r+"Blended/280849_GettyImages-595349545_super_low.jpg");break;case"PROGRAM":t=sap.ui.require.toUrl(r+"Program/276097_276097_l_srgb_s_gl.jpg");break;default:t=sap.ui.require.toUrl(r+"Other/274574_274574_l_srgb_s_gl.jpg")}}return t},handleCourseRating:function(e,t){const o=this.getI18nResource();let r={};if(e.enableRating){for(let n=0;n<t.length;n++){if(t[n].keyString===e.keyString&&t[n].isRatingEnabled&&t[n].totalRating!==null){console.log("###3-Find rating for : "+e.keyString);r.averageRating=(Math.floor(t[n].averageRating*4)/4).toFixed(2);r.totalRating=t[n].totalRating;r.averageRatingTooltip=o.getText("LEARNING_COURSE_AVERAGE_RATING_TOOLTIP",[r.averageRating]);r.totalRatingTooltip=o.getText("LEARNING_COURSE_TOTAL_RATING_TOOLTIP",[r.totalRating]);return r}}console.log("###3-Can't find rating for : "+e.keyString);return null}else{return null}},getSelectedCourses:function(){let e=this.getParameters().mandatoryCourses.value;let t=this.getParameters().optionalCourses.value;console.log("start: mandatory course: "+e.length+"||optional course: "+t.length);function r(e,t){return e.map(e=>e.split(o)).map(e=>({itemID:e[0],itemTypeID:e[1],revisionDate:e[2],mandatory:t}))}e=r(e,true);t=r(t,false);return e.concat(t)}})});
